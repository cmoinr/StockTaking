{% extends 'layout.html' %}
{% block title %}StockTaking | Buscar Producto{% endblock %}
{% block content %}
<div class="busqueda-container">
  <div class="filtros-horizontales">
    <button type="button" class="filtro-btn active" data-filtro="nombre">Nombre</button>
    <button type="button" class="filtro-btn" data-filtro="caracteristica">Característica</button>
    <button type="button" class="filtro-btn" data-filtro="stock">Stock</button>
    <button type="button" class="filtro-btn" data-filtro="precio">Precio</button>
  </div>
  <div id="filtro-nombre" class="filtro-opcion">
    <input type="text" id="busqueda-principal" placeholder="Buscar producto por nombre..." value="{{ query }}">
  </div>
  <div id="filtro-caracteristica" class="filtro-opcion" style="display:none;">
    <input type="text" id="caracteristica-select" placeholder="Característica">
    <input type="text" id="caracteristica-valor" placeholder="Valor">
  </div>
  <div id="filtro-stock" class="filtro-opcion" style="display:none;">
    <select id="stock-comparador">
      <option value="gt">Mayor que</option>
      <option value="lt">Menor que</option>
      <option value="eq">Igual a</option>
    </select>
    <input type="number" id="stock-valor" placeholder="Cantidad">
  </div>
  <div id="filtro-precio" class="filtro-opcion" style="display:none;">
    <select id="precio-comparador">
      <option value="gt">Mayor que</option>
      <option value="lt">Menor que</option>
      <option value="eq">Igual a</option>
    </select>
    <input type="number" id="precio-valor" placeholder="Precio">
    <select id="precio-moneda">
      <option value="$">USD</option>
      <option value="bs">Bs</option>
    </select>
  </div>
  <div class="acciones-busqueda">
    <button id="buscar-btn">Buscar</button>
    <button id="limpiar-btn">Limpiar</button>
  </div>
</div>
<div id="resultados-busqueda"></div>
{% endblock %}
{% block scripts %}
<style>
.busqueda-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-top: 40px;
  padding: 20px 0 0 0;
}
.filtros-horizontales {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  justify-content: center;
}
.filtro-opcion {
  margin-bottom: 18px;
  text-align: center;
}
.filtro-opcion input,
.filtro-opcion select {
  margin: 0 6px;
  padding: 7px 12px;
  border-radius: 6px;
  border: 1px solid #b2dfdb;
  font-size: 1em;
}
.acciones-busqueda {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-top: 10px;
}
.filtro-btn {
  background: #e0f7fa;
  border: none;
  padding: 8px 18px;
  border-radius: 20px;
  font-weight: 600;
  color: #0e5e5a;
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
}
.filtro-btn.active {
  background: #1ec6b6;
  color: #fff;
}
</style>
<script>
// Cambiar filtro activo y mostrar inputs
const filtroBtns = document.querySelectorAll('.filtro-btn');
const filtros = document.querySelectorAll('.filtro-opcion');
filtroBtns.forEach(btn => {
  btn.addEventListener('click', function() {
    filtroBtns.forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    filtros.forEach(f => f.style.display = 'none');
    document.getElementById('filtro-' + this.dataset.filtro).style.display = 'block';
  });
});
// Buscar productos
function recolectarFiltros() {
  const filtroActivo = document.querySelector('.filtro-btn.active').dataset.filtro;
  const data = { filtro_tipo: filtroActivo };
  if (filtroActivo === 'nombre') {
    data.q = document.getElementById('busqueda-principal').value;
  } else if (filtroActivo === 'caracteristica') {
    data.caracteristica = document.getElementById('caracteristica-select').value;
    data.valor_caracteristica = document.getElementById('caracteristica-valor').value;
  } else if (filtroActivo === 'stock') {
    data.stock_comp = document.getElementById('stock-comparador').value;
    data.stock_valor = document.getElementById('stock-valor').value;
  } else if (filtroActivo === 'precio') {
    data.precio_comp = document.getElementById('precio-comparador').value;
    data.precio_valor = document.getElementById('precio-valor').value;
    data.precio_moneda = document.getElementById('precio-moneda').value;
  }
  return data;
}
document.getElementById('buscar-btn').onclick = function() {
  const params = new URLSearchParams(recolectarFiltros());
  fetch('/producto/buscar?' + params, {headers: {'X-Requested-With': 'XMLHttpRequest'}})
    .then(r => r.json())
    .then(data => renderResultados(data));
};
document.getElementById('limpiar-btn').onclick = function() {
  document.getElementById('busqueda-principal').value = '';
  document.getElementById('caracteristica-select').value = '';
  document.getElementById('caracteristica-valor').value = '';
  document.getElementById('stock-valor').value = '';
  document.getElementById('precio-valor').value = '';
  filtroBtns.forEach(b => b.classList.remove('active'));
  filtroBtns[0].classList.add('active');
  filtros.forEach(f => f.style.display = 'none');
  document.getElementById('filtro-nombre').style.display = 'block';
  document.getElementById('resultados-busqueda').innerHTML = '';
};
function renderResultados(products) {
  let html = '<table><tr><th>Nombre</th><th>Categoría</th><th>Características</th><th>Stock</th><th>Precio</th><th>Imagen</th><th></th></tr>';
  if (!products.length) {
    html += '<tr><td colspan="7" style="text-align:center; color:#888; font-style:italic;">No se encontraron productos.</td></tr>';
  } else {
    for (const p of products) {
      html += `<tr>
        <td>${p.nombre}</td>
        <td>${p.categoria || '-'}</td>
        <td>${Object.entries(p.caracteristicas || {}).map(([k,v]) => `<strong>${k}:</strong> ${v}`).join('<br>')}</td>
        <td>${p.stock}</td>
        <td><strong>$:</strong> ${p.precio && p.precio.$ !== undefined ? p.precio.$.toFixed(2) : '-'}<br><strong>Bs.:</strong> ${p.precio && p.precio.bs !== undefined ? p.precio.bs.toFixed(2) : '-'}</td>
        <td>${p.imagen ? `<img src="${p.imagen}" style="max-width:60px;max-height:60px;border-radius:6px;">` : '<span style="color:#aaa;font-size:0.9em;">Sin imagen</span>'}</td>
        <td><a href="/producto/${p._id}/editar" class="button" style="padding:5px 12px;font-size:0.95em;">Editar</a></td>
      </tr>`;
    }
  }
  html += '</table>';
  document.getElementById('resultados-busqueda').innerHTML = html;
}
// Inicializar filtro por nombre visible
window.onload = function() {
  filtros.forEach(f => f.style.display = 'none');
  document.getElementById('filtro-nombre').style.display = 'block';
};
</script>
{% endblock %}